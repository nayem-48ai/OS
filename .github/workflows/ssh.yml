name: Terminus SSH Final
on: 
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  ssh-access:
    runs-on: ubuntu-latest
    steps:
      - name: Install and Setup
        run: |
          sudo apt-get update -y > /dev/null
          sudo apt-get install -y tmate openssh-server > /dev/null
          sudo useradd -m -s /bin/bash tnayem48
          echo "tnayem48:tnayem48" | sudo chpasswd
          sudo usermod -aG sudo tnayem48
          sudo service ssh start

      - name: Generate SSH Access
        run: |
          # tmate সেশন শুরু
          tmate -S /tmp/tmate.sock new-session -d
          
          echo "Waiting for SSH URL..."
          # যতক্ষণ না URL তৈরি হয় ততক্ষণ অপেক্ষা করবে (সর্বোচ্চ ৩০ সেকেন্ড)
          for i in {1..30}; do
            tmate -S /tmp/tmate.sock wait tmate
            SSH_URL=$(tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}')
            if [[ "$SSH_URL" == *"tmate.io"* ]]; then
              break
            fi
            sleep 1
          done

          # URL থেকে হোস্ট এবং পোর্ট আলাদা করা
          # উদাহরণ: ssh abc123@sfo2.tmate.io:12345
          RAW_HOST=$(echo $SSH_URL | cut -d'@' -f2)
          HOST=$(echo $RAW_HOST | cut -d':' -f1)
          PORT=$(echo $RAW_HOST | cut -d':' -f2)

          echo "------------------------------------------"
          echo "   LOGIN DETAILS FOR TERMINUS APP   "
          echo "------------------------------------------"
          echo "Host: $HOST"
          echo "Port: $PORT"
          echo "Username: tnayem48"
          echo "Password: tnayem48"
          echo "------------------------------------------"
          echo "Full Command: $SSH_URL"
          echo "------------------------------------------"
          
          # সেশনটি ৬ ঘণ্টা সচল রাখবে
          sleep 21600
